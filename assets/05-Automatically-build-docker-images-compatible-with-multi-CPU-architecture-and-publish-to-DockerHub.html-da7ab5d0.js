import{_ as t,r as i,o,c as l,a as n,b as s,e,d as c}from"./app-cf578b90.js";const p={},u=n("h2",{id:"preface",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#preface","aria-hidden":"true"},"#"),s(" Preface")],-1),r=n("p",null,"Making an open source project that tries to provide the audience with a quick and easy-to-use experience is also a key to the project's ability to catch people immediately. Now if you want to let users quickly experience the project, in addition to providing a demo environment, there is also a solution, that is, to provide a complete docker-compose, so that people can directly pull up with one click.",-1),d=n("blockquote",null,[n("p",null,"Note: It is Docker-Compose, not K8S's YML, although the production environment directly uses Docker-Compose is rare, but as an intermediate stage, quickly deploy a project experience without too much basic environment configuration, the advantage is still great.")],-1),k=n("p",null,"Therefore, the project should provide the corresponding image, and since there are more and more new CPU architectures on Macs, it is best to provide images that can support multi-CPU architecture.",-1),m=n("p",null,"This article will talk about how to automatically build a docker image compatible with multi-CPU architecture with the help of Github Actions and publish it to DockerHub.",-1),h=n("h2",{id:"disposition",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#disposition","aria-hidden":"true"},"#"),s(" Disposition")],-1),v={href:"https://github.com/docker/build-push-action",target:"_blank",rel:"noopener noreferrer"},b={href:"https://wiki.eryajf.net/pages/95cf71/",target:"_blank",rel:"noopener noreferrer"},y=c(`<p>Using the configuration is actually very simple, basically after reading the official introduction document you can get started to use, here is one or two things to pay attention to.</p><p>Start by adding the Actions profile ，e.g. <code>.github/workflows/docker-image.yml</code>：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># This is a basic workflow to help you get started with Actions</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> build docker image
<span class="token comment"># Controls when the action will run.</span>
<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> main
<span class="token comment"># Allows you to run this workflow manually from the Actions tab</span>
  <span class="token comment"># Can be triggered manually</span>
  <span class="token key atrule">workflow_dispatch</span><span class="token punctuation">:</span>
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">logLevel</span><span class="token punctuation">:</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&#39;Log level&#39;</span>
        <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token string">&#39;warning&#39;</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&#39;Test scenario tags&#39;</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">buildx</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get current date
        <span class="token key atrule">id</span><span class="token punctuation">:</span> date
        <span class="token key atrule">run</span><span class="token punctuation">:</span> echo &quot;<span class="token punctuation">:</span><span class="token punctuation">:</span>set<span class="token punctuation">-</span>output name=today<span class="token punctuation">:</span><span class="token punctuation">:</span>$(date +&#39;%Y<span class="token punctuation">-</span>%m<span class="token punctuation">-</span>%d_%H<span class="token punctuation">-</span>%M&#39;)&quot;

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx
        <span class="token key atrule">id</span><span class="token punctuation">:</span> buildx
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Available platforms
        <span class="token key atrule">run</span><span class="token punctuation">:</span> echo $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.buildx.outputs.platforms <span class="token punctuation">}</span><span class="token punctuation">}</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Login to DockerHub
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/login<span class="token punctuation">-</span>action@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKERHUB_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKERHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and push
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">context</span><span class="token punctuation">:</span> .
          <span class="token key atrule">file</span><span class="token punctuation">:</span> ./Dockerfile
          <span class="token comment"># For the required architecture, you can get all available schemas in the Available platforms step</span>
          <span class="token key atrule">platforms</span><span class="token punctuation">:</span> linux/amd64<span class="token punctuation">,</span>linux/arm64/v8
          <span class="token comment"># Image push time</span>
          <span class="token key atrule">push</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> github.event_name <span class="token tag">!=</span> &#39;pull_request&#39; <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token comment"># Label the list multiple times</span>
          <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            eryajf/go-ldap-admin-server:\${{ steps.date.outputs.today }}
            eryajf/go-ldap-admin-server:latest</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Many configurations are known in name, and the answer can be found in the official documentation, so I will not repeat it here.</p><p>Here are a separate description of several key configuration items:：</p>`,5),g={href:"https://hub.docker.com/settings/security",target:"_blank",rel:"noopener noreferrer"},f=n("li",null,[n("p",null,[n("code",null,"file:"),s("Specifies the location of the Dockerfile file in the project repository.")])],-1),_=n("li",null,[n("p",null,[n("code",null,"platforms："),s("Specify the compatible supported platform architecture required to build the image, usually AMD, ARM is enough.")])],-1),w=n("li",null,[n("p",null,[n("code",null,"tags:"),s("The image tag to be built, what I define here is that every time you build, submit a tag with the timestamp of the image, and then cover the latest tag, so that docker-compose directly uses the latest tag, which can ensure that each new user experience is the latest image when it is pulled up.")])],-1),x=n("p",null,"The final image looks like this:",-1),C=n("p",null,[n("img",{src:"https://cdn.staticaly.com/gh/eryajf/tu/main/img/image_20220723_105957.png",alt:"image_20220723_105957"})],-1),A=n("p",null,"Here you can also see that the images pushed up are compatible with the two CPU architecture platforms.",-1);function D(U,j){const a=i("ExternalLinkIcon");return o(),l("div",null,[u,r,d,k,m,h,n("p",null,[s("Used Actions： "),n("a",v,[s("build-push-action"),e(a)]),s(" Process documentation for multi-CPU image construction："),n("a",b,[s("利用buildx构建支持多CPU架构平台的docker镜像"),e(a)]),s(" ,This content provides a reference for the basics, and you don't need to know too much about the rest of the building.")]),y,n("ul",null,[n("li",null,[n("p",null,[s("The configuration of the DOCKERHUB_TOKEN will not be repeated here, it is configured in the setting of the project, it has been said many times, and the address created by this token is left here："),n("a",g,[s("https://hub.docker.com/settings/security"),e(a)])])]),f,_,w]),x,C,A])}const q=t(p,[["render",D],["__file","05-Automatically-build-docker-images-compatible-with-multi-CPU-architecture-and-publish-to-DockerHub.html.vue"]]);export{q as default};
